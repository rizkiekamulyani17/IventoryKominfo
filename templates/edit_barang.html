{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Edit Barang</h2>
    <form method="POST" enctype="multipart/form-data">
        <!-- Input standar -->
        <div class="form-group mb-2">
            <label>Kode Barang</label>
            <input type="text" name="kode_barang" class="form-control" value="{{ barang['kode_barang'] }}" required>
        </div>
        <div class="form-group mb-2">
            <label>Nama Barang</label>
            <input type="text" name="nama_barang" class="form-control" value="{{ barang['nama_barang'] }}" required>
        </div>
        <div class="form-group mb-2">
            <label>Merk/Model</label>
            <input type="text" name="merk" class="form-control" value="{{ barang['merk'] }}">
        </div>
        <div class="form-group mb-2">
            <label>No. Seri Pabrik</label>
            <input type="text" name="no_seri" class="form-control" value="{{ barang['no_seri'] }}">
        </div>
        <div class="form-group mb-2">
            <label>Ukuran</label>
            <input type="text" name="ukuran" class="form-control" value="{{ barang['ukuran'] }}">
        </div>
        <div class="form-group mb-2">
            <label>Bahan</label>
            <input type="text" name="bahan" class="form-control" value="{{ barang['bahan'] }}">
        </div>
        <div class="form-group mb-2">
            <label>Tahun Pembelian</label>
            <input type="number" name="tahun" class="form-control" value="{{ barang['tahun'] }}">
        </div>
        <div class="form-group mb-2">
            <label>Jumlah</label>
            <input type="number" name="jumlah" class="form-control" value="{{ barang['jumlah'] }}">
        </div>
        <div class="form-group mb-2">
            <label>Kondisi</label>
            <select name="kondisi" class="form-control">
                <option value="Baik" {% if barang['kondisi'] == 'Baik' %}selected{% endif %}>Baik</option>
                <option value="Kurang Baik" {% if barang['kondisi'] == 'Kurang Baik' %}selected{% endif %}>Kurang Baik</option>
                <option value="Rusak Berat" {% if barang['kondisi'] == 'Rusak Berat' %}selected{% endif %}>Rusak Berat</option>
            </select>
        </div>
        <div class="form-group mb-2">
            <label>Harga Beli</label>
            <input type="number" name="harga_beli" class="form-control" value="{{ barang['harga_beli'] }}">
        </div>
        <div class="form-group mb-2">
            <label>Ruangan</label>
            <select name="ruangan_id" class="form-control" required>
                {% for r in ruangan_list %}
                    <option value="{{ r['_id'] }}" {% if r['_id'] == barang['ruangan_id'] %}selected{% endif %}>
                        {{ r['nama_ruangan'] }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mb-2">
            <label for="keterangan">Keterangan</label>
            <textarea class="form-control" id="keterangan" name="keterangan">{{ barang.keterangan }}</textarea>
        </div>

        <!-- Foto Barang + Kamera -->
        <div class="mb-3">
            <label class="form-label">Foto Barang</label><br>
            <div id="previewContainer">
                {% if barang.get("foto") %}
                    {% for f in barang.foto %}
                        <div class="foto-wrapper position-relative d-inline-block me-2 mb-2">
                            <img src="{{ url_for('static', filename=f.replace('static/','')) }}" class="img-thumbnail" width="100">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 remove-foto" data-foto="{{ f }}" style="border-radius:50%;">&times;</button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <input type="hidden" name="hapus_foto[]" id="hapusFotoInput">
            <input type="file" id="fotoFile" name="foto[]" class="form-control" accept="image/*" multiple>
            <button type="button" class="btn btn-info mt-2" onclick="openCamera()">Ambil Kamera</button>

            <div class="mt-2">
                <video id="camera" autoplay playsinline style="display:none; width:100%;" class="img-thumbnail"></video>
                <button type="button" id="captureBtn" class="btn btn-warning mt-2" style="display:none;">Capture</button>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
        <a href="{{ url_for('barang.index', kode=barang['_id']) }}" class="btn btn-secondary">Batal</a>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let stream;
    const fotoInput = document.getElementById('fotoFile');
    const previewContainer = document.getElementById('previewContainer');
    const video = document.getElementById('camera');
    const captureBtn = document.getElementById('captureBtn');
    const hapusFotoInput = document.getElementById('hapusFotoInput');

    let dataTransfer = new DataTransfer(); // menampung semua file baru
    let fotoHapus = []; // menampung path foto lama yang akan dihapus

    // Hapus foto lama atau baru
    previewContainer.addEventListener('click', function(e) {
        if(e.target.classList.contains('remove-foto')){
            const wrapper = e.target.closest('.foto-wrapper');
            const fotoPath = e.target.getAttribute('data-foto');
            if(fotoPath) {
                fotoHapus.push(fotoPath);
                hapusFotoInput.value = fotoHapus.join(',');
            }
            wrapper.remove();
        }
    });

    // Upload file manual (banyak sekaligus)
    fotoInput.addEventListener('change', function(event) {
        for (let file of event.target.files) {
            dataTransfer.items.add(file);

            const wrapper = document.createElement('div');
            wrapper.classList.add('foto-wrapper','position-relative','d-inline-block','me-2','mb-2');

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxHeight = '100px';
            img.classList.add('img-thumbnail');

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.classList.add('btn','btn-sm','btn-danger','position-absolute','top-0','end-0','remove-foto');
            btn.innerHTML = '&times;';
            btn.addEventListener('click', function() {
                wrapper.remove();
                dataTransfer.items.remove(dataTransfer.items.length - 1);
                fotoInput.files = dataTransfer.files;
            });

            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            previewContainer.appendChild(wrapper);
        }
        fotoInput.files = dataTransfer.files;
    });

    // Buka kamera
    window.openCamera = function() {
        if (!navigator.mediaDevices?.getUserMedia) {
            alert("Kamera tidak didukung di perangkat ini.");
            return;
        }
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => {
                stream = s;
                video.srcObject = stream;
                video.style.display = 'block';
                captureBtn.style.display = 'inline-block';
            })
            .catch(err => alert('Tidak bisa mengakses kamera: ' + err));
    }

    // Capture foto dari kamera
    captureBtn.addEventListener('click', function() {
        if (!stream) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        canvas.toBlob(blob => {
            const file = new File([blob], "foto_barang.png", { type: "image/png" });
            dataTransfer.items.add(file);
            fotoInput.files = dataTransfer.files;

            const wrapper = document.createElement('div');
            wrapper.classList.add('foto-wrapper','position-relative','d-inline-block','me-2','mb-2');

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxHeight = '100px';
            img.classList.add('img-thumbnail');

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.classList.add('btn','btn-sm','btn-danger','position-absolute','top-0','end-0','remove-foto');
            btn.innerHTML = '&times;';
            btn.addEventListener('click', function() {
                wrapper.remove();
                dataTransfer.items.remove(dataTransfer.items.length - 1);
                fotoInput.files = dataTransfer.files;
            });

            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            previewContainer.appendChild(wrapper);
        }, 'image/png');

        // Stop kamera
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        captureBtn.style.display = 'none';
    });
});
</script>
{% endblock %}
