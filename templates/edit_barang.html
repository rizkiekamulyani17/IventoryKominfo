{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Edit Barang</h2>
    <form method="POST" enctype="multipart/form-data">
        <!-- Input standar tetap sama -->
        <div class="form-group mb-2">
            <label>Kode Barang</label>
            <input type="text" name="kode_barang" class="form-control" value="{{ barang['kode_barang'] }}" required>
        </div>

        <div class="form-group mb-2">
            <label>Nama Barang</label>
            <input type="text" name="nama_barang" class="form-control" value="{{ barang['nama_barang'] }}" required>
        </div>

        <div class="form-group mb-2">
            <label>Merk/Model</label>
            <input type="text" name="merk" class="form-control" value="{{ barang['merk'] }}">
        </div>

        <div class="form-group mb-2">
            <label>No. Seri Pabrik</label>
            <input type="text" name="no_seri" class="form-control" value="{{ barang['no_seri'] }}">
        </div>

        <div class="form-group mb-2">
            <label>Ukuran</label>
            <input type="text" name="ukuran" class="form-control" value="{{ barang['ukuran'] }}">
        </div>

        <div class="form-group mb-2">
            <label>Bahan</label>
            <input type="text" name="bahan" class="form-control" value="{{ barang['bahan'] }}">
        </div>

        <div class="form-group mb-2">
            <label>Tahun Pembelian</label>
            <input type="number" name="tahun" class="form-control" value="{{ barang['tahun'] }}">
        </div>

        <div class="form-group mb-2">
            <label>Jumlah</label>
            <input type="number" name="jumlah" class="form-control" value="{{ barang['jumlah'] }}">
        </div>

        <div class="form-group mb-2">
            <label>Kondisi</label>
            <select name="kondisi" class="form-control">
                <option value="Baik" {% if barang['kondisi'] == 'Baik' %}selected{% endif %}>Baik</option>
                <option value="Kurang Baik" {% if barang['kondisi'] == 'Kurang Baik' %}selected{% endif %}>Kurang Baik</option>
                <option value="Rusak Berat" {% if barang['kondisi'] == 'Rusak Berat' %}selected{% endif %}>Rusak Berat</option>
            </select>
        </div>

        <div class="form-group mb-2">
            <label>Harga Beli</label>
            <input type="number" name="harga_beli" class="form-control" value="{{ barang['harga_beli'] }}">
        </div>

        <div class="form-group mb-2">
            <label>Ruangan</label>
            <select name="ruangan_id" class="form-control" required>
                {% for r in ruangan_list %}
                    <option value="{{ r['_id'] }}" {% if r['_id'] == barang['ruangan_id'] %}selected{% endif %}>
                        {{ r['nama_ruangan'] }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group mb-2">
            <label for="keterangan">Keterangan</label>
            <textarea class="form-control" id="keterangan" name="keterangan">{{ barang.keterangan }}</textarea>
        </div>

        <!-- Foto Barang + Kamera -->
        <div class="mb-3">
            <label class="form-label">Foto Barang</label><br>
            {% if barang.get("foto") %}
                <img src="{{ url_for('static', filename=barang['foto'].replace('static/','')) }}" 
                     alt="Foto Barang" class="img-thumbnail mb-2" width="150">
            {% endif %}
            <input type="file" id="fotoFile" name="foto" class="form-control" accept="image/*">
            <button type="button" class="btn btn-info mt-2" onclick="openCamera()">Ambil Kamera</button>

            <div class="mt-2">
                <video id="camera" autoplay playsinline style="display:none; width:100%;" class="img-thumbnail"></video>
                <button type="button" id="captureBtn" class="btn btn-warning mt-2" style="display:none;" onclick="capturePhoto()">Capture</button>
            </div>

            <div class="mt-2">
                <img id="preview" src="" alt="Preview Foto" style="max-height:200px; display:none;" class="img-thumbnail">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
        <a href="{{ url_for('barang.index', kode=barang['_id']) }}" class="btn btn-secondary">Batal</a>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let stream;

    const fotoInput = document.getElementById('fotoFile');
    const previewImg = document.getElementById('preview');
    const video = document.getElementById('camera');
    const captureBtn = document.getElementById('captureBtn');

    // Preview file upload biasa
    fotoInput.addEventListener('change', function(event) {
        if(event.target.files.length > 0){
            previewImg.src = URL.createObjectURL(event.target.files[0]);
            previewImg.style.display = 'block';
        }
    });

    // Fungsi buka kamera
    window.openCamera = function() {
        if (!navigator.mediaDevices?.getUserMedia) {
            alert("Kamera tidak didukung di perangkat ini. Silakan unggah foto.");
            return;
        }

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => {
                stream = s;
                video.srcObject = stream;
                video.style.display = 'block';
                captureBtn.style.display = 'inline-block';
            })
            .catch(err => alert('Tidak bisa mengakses kamera: ' + err));
    }

    // Fungsi capture foto dari kamera
    window.capturePhoto = function() {
        if(!stream) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        canvas.toBlob(blob => {
            const file = new File([blob], "foto_barang.png", { type: "image/png" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fotoInput.files = dataTransfer.files;

            previewImg.src = URL.createObjectURL(file);
            previewImg.style.display = 'block';
        }, 'image/png');

        // Stop kamera
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        captureBtn.style.display = 'none';
    }
});
</script>
{% endblock %}
