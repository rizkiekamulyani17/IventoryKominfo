{% extends 'base.html' %}

{% block content %}
<div class="mutasi-container">
    <h2 class="title">📦 Mutasi Barang</h2>

    <!-- Bar pencarian -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="🔍 Cari Nama Barang / Ruangan / Keterangan...">
    </div>

    <!-- Tabel responsif -->
    <div class="table-wrapper">
        <table id="mutasiTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Barang</th>
                    <th>Kode Barang</th>
                    <th>Ruangan Saat Ini</th>
                    <th>Keterangan</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for b in barang_list %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ b['nama_barang'] }}</td>
                    <td>{{ b['kode_barang'] }}</td>
                    <td>{{ b['nama_ruangan'] }}</td>
                    <td>{{ b.get('keterangan_luar', '') }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('mutasi.mutasi_barang', barang_id=b['_id']) }}" class="aksi-form">
                            <select name="ruangan_tujuan_id" class="ruanganSelect" required>
                                <option value="" disabled selected>-- Pilih Ruangan --</option>
                                {% for r in ruangan_list %}
                                <option value="{{ r['_id'] }}">{{ r['nama_ruangan'] }}</option>
                                {% endfor %}
                                <option value="luar_kantor">Luar Kantor</option>
                            </select>

                            <input type="text" name="keterangan_luar" class="keteranganLuar" 
                                   placeholder="Keterangan (tujuan luar kantor)" style="display:none;">

                            <button type="submit" class="btn-primary">Mutasi</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        <button id="prevBtn" class="btn-primary">Previous</button>
        <button id="nextBtn" class="btn-primary">Next</button>
    </div>
</div>

<style>
/* Container utama */
.mutasi-container {
    font-family: 'Segoe UI', sans-serif;
    margin: 20px;
    animation: fadeIn 0.6s ease-in-out;
}

/* Animasi masuk */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Judul */
.title {
    text-align: center;
    color: #1e3c72;
    margin-bottom: 20px;
    font-size: 1.7rem;
    font-weight: bold;
}

/* Search bar */
.search-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 15px;
}
.search-bar input {
    flex: 1 1 250px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    min-width: 200px;
    transition: 0.3s;
}
.search-bar input:focus {
    border-color: #2575fc;
    outline: none;
    box-shadow: 0 0 6px rgba(37,117,252,0.3);
}

/* Table wrapper */
.table-wrapper {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

/* Tabel */
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
}
thead tr {
    background: linear-gradient(90deg, #2575fc, #6a11cb);
    color: #fff;
    text-align: center;
}
th, td {
    padding: 12px;
    border: 1px solid #eee;
    text-align: center;
    font-size: 14px;
}
tbody tr:nth-child(even) { background: #f9f9f9; }
tbody tr:hover { background: #e6f0ff; transition: 0.2s; }

/* Form aksi */
.aksi-form {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
    align-items: center;
}
.aksi-form select, 
.aksi-form input {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 13px;
}
.aksi-form input.keteranganLuar {
    width: 100%;
}

/* Button */
.btn-primary {
    padding: 7px 14px;
    border: none;
    border-radius: 6px;
    background: #2575fc;
    color: white;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s ease;
}
.btn-primary:hover { 
    background: #1a5edb; 
    transform: scale(1.05);
}
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }

/* Pagination */
.pagination {
    margin-top: 15px;
    text-align: center;
    display: flex;
    justify-content: center;
    gap: 10px;
}

/* Responsiveness */
@media (max-width: 768px) {
    table { font-size: 12px; }
    th, td { padding: 8px; }
    .aksi-form { flex-direction: column; }
    .aksi-form select, .aksi-form input, .aksi-form button { width: 100%; }
}
</style>

<script>
const searchInput = document.getElementById('searchInput');
const table = document.getElementById('mutasiTable');
const rows = Array.from(table.querySelectorAll('tbody tr'));
const rowsPerPage = 10;
let currentPage = 1;

function renderTable() {
    const filter = searchInput.value.toLowerCase();
    const filteredRows = rows.filter(row => {
        const namaBarang = row.cells[1].textContent.toLowerCase();
        const kodeBarang = row.cells[2].textContent.toLowerCase();
        const ruangan = row.cells[3].textContent.toLowerCase();
        const keterangan = row.cells[4].textContent.toLowerCase();
        return namaBarang.includes(filter) || kodeBarang.includes(filter) || ruangan.includes(filter) || keterangan.includes(filter);
    });

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    rows.forEach(r => r.style.display = 'none');
    filteredRows.slice(start, end).forEach(r => r.style.display = '');

    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filteredRows.length;
}

// Event pencarian
searchInput.addEventListener('keyup', function() { 
    currentPage = 1; 
    renderTable(); 
});

// Pagination
document.getElementById('prevBtn').addEventListener('click', function() { 
    if(currentPage > 1){ currentPage--; renderTable(); } 
});
document.getElementById('nextBtn').addEventListener('click', function() { 
    currentPage++; renderTable(); 
});

// Render pertama
renderTable();

// Show/hide keterangan luar kantor
document.querySelectorAll('.ruanganSelect').forEach(select => {
    select.addEventListener('change', function() {
        const keteranganInput = this.parentElement.querySelector('.keteranganLuar');
        if(this.value === 'luar_kantor') {
            keteranganInput.style.display = 'inline-block';
            keteranganInput.required = true;
        } else {
            keteranganInput.style.display = 'none';
            keteranganInput.required = false;
            keteranganInput.value = '';
        }
    });
});
</script>
{% endblock %}
