{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">Detail Ruangan: {{ ruangan['nama_ruangan'] }}</h2>
    <p><strong>Kode Ruangan:</strong> {{ ruangan['kode_ruangan'] }}</p>
    <p><strong>Kode Lokasi:</strong> {{ ruangan['kode_lokasi'] }}</p>

    <!-- QR Ruangan -->
    <div class="mb-3">
        {% if ruangan.qris_path %}
        <img src="{{ url_for('static', filename=ruangan.qris_path.replace('static/', '')) }}" 
             width="120" style="border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        {% else %}
        <span class="text-muted">QR Code belum dibuat</span>
        {% endif %}
    </div>

    <!-- Tombol Download -->
    {% if session.get('username') %}
    <div class="mb-4 d-flex gap-2">
        <a href="{{ url_for('ruangan.download_qris_ruangan', ruangan_id=ruangan['_id']) }}" 
           class="btn btn-danger">
           <i class="bi bi-qr-code me-1"></i> Download QR Code
        </a>
        <a href="{{ url_for('ruangan.download_data_pdf', ruangan_id=ruangan['_id']) }}" 
           class="btn btn-primary">
           <i class="bi bi-file-earmark-pdf me-1"></i> Download Data PDF
        </a>
    </div>
    {% endif %}

    <!-- Tabel Barang -->
    <div class="table-responsive">
        <table id="barangTable" class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>No</th>
                    <th>Foto</th>
                    <th>Kode Barang</th>
                    <th>Nama Barang</th>
                    <th>Merk</th>
                    <th>No Seri</th>
                    <th>Ukuran</th>
                    <th>Bahan</th>
                    <th>Tahun</th>
                    <th>Kondisi</th>
                    <th>Harga Beli</th>
                    <th>Keterangan</th>
                    <th>File BAST</th> 
                    {% if session.get('username') %}
                    <th class="text-center">Aksi</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for b in barang %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        {% if b.foto %}
                            {% if b.foto is string %}
                                <img src="{{ url_for('static', filename=b.foto.replace('static/','')) }}"
                                     alt="Foto {{ b.nama_barang }}"
                                     class="img-thumbnail"
                                     style="max-width:120px; max-height:120px; cursor:pointer;"
                                     data-bs-toggle="modal" data-bs-target="#fotoModal{{ b._id }}">
                            {% elif b.foto is iterable %}
                                <div class="d-flex flex-wrap">
                                    {% for f in b.foto %}
                                        <img src="{{ url_for('static', filename=f.replace('static/','')) }}"
                                             alt="Foto {{ b.nama_barang }}"
                                             class="img-thumbnail me-2 mb-2"
                                             style="max-width:120px; max-height:120px; cursor:pointer;"
                                             data-bs-toggle="modal" data-bs-target="#fotoModal{{ b._id }}-{{ loop.index }}">
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Tidak ada foto</span>
                        {% endif %}
                    </td>
                    <td>{{ b.kode_barang }}</td>
                    <td>{{ b.nama_barang }}</td>
                    <td>{{ b.merk }}</td>
                    <td>{{ b.no_seri }}</td>
                    <td>{{ b.ukuran }}</td>
                    <td>{{ b.bahan }}</td>
                    <td>{{ b.tahun }}</td>
                    <td>{{ b.kondisi }}</td>
                    <td>Rp {{ "{:,.0f}".format(b.harga_beli) }}</td>
                    <td>{{ b.keterangan or '-' }}</td>
                    <td>
                        {% if b.file_bast %}
                            {% set filename = b.file_bast.split('/')[-1] %}
                            <a href="{{ url_for('static', filename=b.file_bast.replace('static/','')) }}" target="_blank">
                                <i class="bi bi-file-earmark-text"></i> {{ filename }}
                            </a>
                        {% else %}
                            <span class="text-muted">Tidak ada</span>
                        {% endif %}
                    </td>
                    {% if session.get('username') %}
                    <td class="text-center">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-gear"></i> Aksi
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('barang.edit_kondisi', barang_id=b._id) }}">
                                        <i class="bi bi-tools me-2"></i>Edit Kondisi
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('barang.edit', barang_id=b._id) }}">
                                        <i class="bi bi-pencil-square me-2"></i>Edit Data
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tombol Kembali -->
    <a href="{{ url_for('ruangan.index') }}" class="btn btn-secondary mt-3">
        <i class="bi bi-arrow-left-circle"></i> Kembali
    </a>
</div>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function () {
        $('#barangTable').DataTable({
            "pageLength": 10,
            "ordering": true,
            "searching": true,
            "language": {
                "search": "üîç Cari:",
                "lengthMenu": "Tampilkan _MENU_ data per halaman",
                "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ data"
            }
        });
    });
</script>
{% endblock %}
